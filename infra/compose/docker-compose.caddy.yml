name: sandboxforge-caddy
services:
  postgres:
    image: postgres:16-alpine
    ports: ["${POSTGRES_PORT:-5432}:5432"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app_password}
      POSTGRES_DB: ${POSTGRES_DB:-sandboxforge}
    volumes:
      - pg-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports: ["${REDIS_PORT:-6379}:6379"]
    volumes: [ "redis-data:/data" ]

  seq:
    image: datalust/seq:latest
    profiles: ["obs"]
    ports: ["${SEQ_PORT:-5341}:80"]
    environment:
      ACCEPT_EULA: "Y"
    volumes:
      - seq-data:/data

  grafana:
    image: grafana/grafana:latest
    ports: ["${GRAFANA_PORT:-3001}:3000"]
    volumes:
      - grafana-data:/var/lib/grafana

  # Static web site served by nginx; proxied by Caddy
  web:
    image: nginx:alpine
    volumes:
      - ../../apps/web:/usr/share/nginx/html:ro
    networks: [edge]

  # Reverse proxy (replaces Traefik)
  # For Cloudflare Tunnel we do NOT expose host ports 80/443.
  caddy:
    image: caddy:2-alpine
    ports:
      - "8080:80"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - web
    networks: [edge]

  # Outbound-only tunnel to Cloudflare edge
  cloudflared:
    image: cloudflare/cloudflared:latest
    env_file:
      - ../env/dev.env
    # cloudflared can read the token from TUNNEL_TOKEN env var directly
    command: ["cloudflared","tunnel","--no-autoupdate","--protocol","http2","run"]
    environment:
      - TUNNEL_TRANSPORT_PROTOCOL=http2
    depends_on:
      - caddy
    networks: [edge]

volumes:
  pg-data:
  redis-data:
  seq-data:
  grafana-data:
  caddy_data:
  caddy_config:

networks:
  edge:
    name: sandboxforge-edge
